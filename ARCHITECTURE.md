# BlueStacks 網路連線架構圖

```
┌─────────────────────────────────────────────────────────────────────┐
│                          主機 (Host Machine)                         │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │  Python Mock Server                                         │   │
│  │  監聽: 0.0.0.0:8000                                         │   │
│  │                                                              │   │
│  │  ✓ GET /           → 狀態檢查                              │   │
│  │  ✓ POST /face/v1.0/detect → Mock 人臉資料                 │   │
│  └────────────────────────────────────────────────────────────┘   │
│                             ↑                                        │
│                             │ HTTP                                   │
│                             │                                        │
│  ┌──────────────────────────┼─────────────────────────────────┐   │
│  │                          │                                   │   │
│  │  方案 A: 10.0.2.2        │  方案 B: adb reverse             │   │
│  │  (直接連接)              │  (Port 轉發)                     │   │
│  │                          │                                   │   │
│  └──────────────────────────┼─────────────────────────────────┘   │
│                             │                                        │
└─────────────────────────────┼────────────────────────────────────┘
                              │
                              │ 虛擬網路橋接
                              │
┌─────────────────────────────┼────────────────────────────────────┐
│                             ↓                                        │
│                   BlueStacks 模擬器                                  │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │  Android App (PeopleAnalyser)                                │  │
│  │                                                               │  │
│  │  方案 A: http://10.0.2.2:8000                               │  │
│  │  方案 B: http://localhost:8000 (需 adb reverse)             │  │
│  │                                                               │  │
│  │  ┌──────────────────────────────────────┐                   │  │
│  │  │  FaceApiClient.kt                     │                   │  │
│  │  │  ↓                                     │                   │  │
│  │  │  OkHttp Client                        │                   │  │
│  │  │  ↓                                     │                   │  │
│  │  │  POST /face/v1.0/detect               │                   │  │
│  │  │  Content-Type: application/octet-stream│                   │  │
│  │  │  Body: JPEG bytes                     │                   │  │
│  │  └──────────────────────────────────────┘                   │  │
│  │                                                               │  │
│  │  Network Security Config:                                    │  │
│  │  ✓ cleartext traffic 已允許                                 │  │
│  │  ✓ 信任 localhost, 127.0.0.1, 10.0.2.2                     │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                      │
└──────────────────────────────────────────────────────────────────┘
```

## 方案 A：使用 10.0.2.2（推薦）

```
主機 Mock Server          BlueStacks Android
  (0.0.0.0:8000)          (內部 IP 未知)
       ↑                         │
       │                         │
       │    10.0.2.2:8000       │
       │◄───────────────────────│
       │                         │
       │    JSON Response        │
       │────────────────────────►│
```

**特點**：
- ✅ 無需 ADB
- ✅ 配置簡單
- ✅ 自動橋接

**限制**：
- ⚠️ 只適用模擬器
- ⚠️ 實機無法使用此 IP

## 方案 B：使用 adb reverse

```
主機                           BlueStacks
  │                               │
  │  adb connect 127.0.0.1:5555   │
  │◄──────────────────────────────│ 建立 ADB 連接
  │                               │
  │  adb reverse tcp:8000 tcp:8000│
  │◄──────────────────────────────│ 設定 Port 轉發
  │                               │
  │                               │
Mock Server ◄───┐           ┌───► Android App
(localhost:8000)│           │    (localhost:8000)
                │           │
                └───────────┘
                  Port 轉發
```

**特點**：
- ✅ 使用標準 URL (localhost)
- ✅ 可使用其他 ADB 功能 (logcat, shell)
- ✅ 更符合生產環境

**限制**：
- ⚠️ 需要安裝 ADB
- ⚠️ BlueStacks 重啟後需重新設定
- ⚠️ 需要 USB 偵錯授權

## 診斷流程圖

```
開始
  │
  ▼
┌────────────────┐
│ Mock Server    │ ──NO──► 啟動 Mock Server
│ 是否執行？     │         python scripts\mock_server.py
└────────────────┘
  │ YES
  ▼
┌────────────────┐
│ 本機連線       │ ──NO──► 檢查防火牆
│ 是否正常？     │         允許 Python 通過
└────────────────┘
  │ YES
  ▼
┌────────────────┐
│ ADB            │ ──NO──► 安裝 Platform Tools
│ 是否可用？     │         使用方案 A (10.0.2.2)
└────────────────┘
  │ YES
  ▼
┌────────────────┐
│ BlueStacks     │ ──NO──► adb connect 127.0.0.1:5555
│ 是否連接？     │         啟用 BlueStacks ADB 設定
└────────────────┘
  │ YES
  ▼
┌────────────────┐
│ adb reverse    │ ──NO──► adb reverse tcp:8000 tcp:8000
│ 是否設定？     │         
└────────────────┘
  │ YES
  ▼
連線成功！
在 App 中使用
- 方案 A: http://10.0.2.2:8000
- 方案 B: http://localhost:8000
```

## 數據流向

```
1. App 發送請求
   ┌──────────────────────────────────────────┐
   │ FaceApiClient.detectFaces(jpegBytes)      │
   │   → OkHttp Client                         │
   │   → POST http://10.0.2.2:8000/face/...   │
   └──────────────────────────────────────────┘
                    │
                    ▼ (透過虛擬網路橋接)
   ┌──────────────────────────────────────────┐
   │ Mock Server 收到請求                      │
   │   → 讀取 Content-Length                   │
   │   → 解析 JPEG bytes                       │
   │   → 回傳 Mock 資料                        │
   └──────────────────────────────────────────┘
                    │
                    ▼
2. Server 回應
   ┌──────────────────────────────────────────┐
   │ HTTP 200 OK                               │
   │ Content-Type: application/json            │
   │ Body: [                                   │
   │   {                                        │
   │     "faceId": "mock-face-001",            │
   │     "gender": "male",                     │
   │     "age": 28.0,                          │
   │     ...                                   │
   │   }                                        │
   │ ]                                         │
   └──────────────────────────────────────────┘
                    │
                    ▼ (透過虛擬網路橋接)
3. App 處理回應
   ┌──────────────────────────────────────────┐
   │ FaceApiClient 解析 JSON                   │
   │   → 建立 FaceData 物件列表                │
   │   → 回傳給 MainActivity                   │
   │   → 更新 UI (人數、性別、年齡統計)       │
   └──────────────────────────────────────────┘
```

## Windows 防火牆規則

```
┌─────────────────────────────────────────────┐
│  Windows Defender 防火牆                     │
│                                              │
│  ┌────────────────────────────────────┐    │
│  │  輸入規則                           │    │
│  │                                     │    │
│  │  ✓ Python (私人網路)               │    │
│  │  ✓ Python (公用網路)               │    │
│  │                                     │    │
│  │  允許連線到 Port 8000               │    │
│  └────────────────────────────────────┘    │
│                                              │
│                    ↓                         │
│                                              │
│  ┌────────────────────────────────────┐    │
│  │  Mock Server (python.exe)           │    │
│  │  監聽 0.0.0.0:8000                  │    │
│  └────────────────────────────────────┘    │
│                                              │
└─────────────────────────────────────────────┘
                    ↑
                    │ 允許外部連線
                    │
            BlueStacks 模擬器
```

## 檔案結構

```
PeopleAnalyser/
├── scripts/
│   ├── mock_server.py              # Mock Face API Server
│   ├── start_mock_server.ps1       # 快速啟動腳本
│   └── diagnose_connection.ps1     # 診斷工具
├── app/src/main/
│   ├── AndroidManifest.xml         # 已加入 networkSecurityConfig
│   ├── res/xml/
│   │   └── network_security_config.xml  # 允許 cleartext traffic
│   └── java/com/uka/peopleanalyser/
│       ├── FaceApiClient.kt        # API 呼叫
│       └── MainActivity.kt         # UI 邏輯
├── BLUESTACKS_SETUP.md             # 詳細設定指南
├── TESTING.md                      # 測試驗證步驟
├── SOLUTION_SUMMARY.md             # 解決方案總結
└── README.md                       # 專案說明（已更新）
```

## 時序圖：完整測試流程

```
使用者          腳本                Mock Server      BlueStacks       App
  │              │                      │               │              │
  │─啟動────────►│                      │               │              │
  │              │─檢查 Python──►     │               │              │
  │              │◄─────OK─────       │               │              │
  │              │─執行 mock_server.py►│               │              │
  │              │                      │─監聽 8000     │              │
  │              │◄─────啟動成功───────│               │              │
  │◄─顯示 URL───│                      │               │              │
  │              │                      │               │              │
  │─開啟瀏覽器──────────────────────────────►│              │
  │                                     │──GET /──────►│              │
  │                                     │◄─JSON────────│              │
  │◄────────────顯示狀態頁面────────────────│              │
  │                                                     │              │
  │─開啟 App────────────────────────────────────────────►│
  │                                                     │─設定端點────►│
  │                                                     │              │─detectFaces()
  │                                                     │              │─POST /face...
  │                                     │◄──────────────────────────────│
  │                                     │─Mock 資料──────────────────────►│
  │                                                     │              │─解析 JSON
  │                                                     │              │─更新 UI
  │◄────────────────────────────────────────────────────────顯示人數──│
```

---

**說明**：
- 實線 (─) 表示正常流向
- 箭頭 (►/◄) 表示資料傳輸方向
- 虛線表示選擇性路徑
